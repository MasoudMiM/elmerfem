#!/bin/bash
#
# Autoconf substitutes @VAR@ definitions to come up with a 
# semi-valid test script
# 
if test "$SHL_EXT" = ""; then
    SHL_EXT=".@SHLEXT@"
fi
if test "$OBJ_EXT" = ""; then
    OBJ_EXT=".@OBJEXT@"
fi

export SHL_EXT
export OBJ_EXT

if test "$ELMER_HOME" = ""; then
    # assume that we are testing local version
    printf "\$ELMER_HOME undefined, setting it to ../src\n"
    export ELMER_HOME="../../src"
    export ELMER_LIB="../../src"
    export ELMER_GRID="../../src/elmergrid/ElmerGrid"
    export ELMER_SOLVER="../../src/ElmerSolver"
    export ELMER_MESH2D="../../src/meshgen2d/Mesh2D"
    export LD_LIBRARY_PATH=".:$ELMER_HOME:$LD_LIBRARY_PATH"
    export PATH=$ELMER_HOME:$ELMER_HOME/meshgen2d:$PATH
else 
    # ELMER_HOME is defined, so we'll just use that
    printf "\$ELMER_HOME=%s\n" $ELMER_HOME
    export ELMER_LIB="$ELMER_HOME/share/elmersolver/lib"
    export ELMER_GRID="$ELMER_HOME/bin/ElmerGrid"
    export ELMER_SOLVER="$ELMER_HOME/bin/ElmerSolver"
    export ELMER_MESH2D="$ELMER_HOME/bin/Mesh2D"
    export LD_LIBRARY_PATH=".:$ELMER_HOME/share/elmersolver/lib:$LD_LIBRARY_PATH"
    export PATH=$ELMER_HOME/bin:$PATH
fi

#
# Autoconf substitutes these variables with correct values.
#
export F90="@FC@ @TESTS_FCFLAGS@"
export LD="@SH_LD@ @SH_LDFLAGS@ @SH_LINKING_TO_FLAGS@ @B64FLAGS@"
export LIBS="-L$ELMER_LIB -lsolver"

cc -o findnorm findnorm.c
cc -o compare compare.c -lm
chmod 775 findnorm compare

total=0
passed=0

if test "$1" == ""; then
   dirs=`find . -type d |sed -e 's/\// /g' |gawk '{print $2}' |uniq |grep -v CVS`
else
   dirs="$*"
fi

for dir in $dirs; do

      total=`expr $total + 1`
      cwd=`pwd`
      cd $dir
      printf "testing:  %20s " $dir
      make  > test.log 2>&1

      success=`grep "ALL DONE" test.log | wc -l`
      if test $success -ge 1; then
	  correctResult=`cat TEST.RESULT`
	  grep "(NRM,RELC)" test.log > temp.log
	  resultNorm=`../findnorm temp.log`
	  success=`../compare $resultNorm $correctResult`
      fi

      if test $success -ge 1; then
	  passed=`expr $passed + 1`
          printf "			[PASSED]\n"
	  make -i clean > /dev/null 2>&1
      else
          printf " [FAILED] look at %20s/test.log for details\n" $dir
      fi
      cd $cwd
done

echo "Tests completed, passed: $passed out of total $total tests"
