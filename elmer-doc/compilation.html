<html><head>
  <title>Compiling</title>
  <link rel="stylesheet" href="elmer.css"/>
  <meta category="compiling"/>
</head>
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> -->

<body>
<h1>Compiling</h1>

<h2>Quick start</h2>

<p>
Make sure you have a working f90 compiler (preferably one that is
listed in <a href="#compilers">this</a> table). Then pick an
installation directory, e.g., /opt/elmer, /home/username or /usr
(default). Then compile the elmer <a href="download.html">source
packages</a> in the following order: matc, umfpack, mathlibs,
elmergrid, meshgen2d, eio, hutiter, fem using the normal procedure of
<code>./configure ; make ; make install</code>, or use the following
convenience script:
</p>

<pre>
<span class="comment">#!/bin/sh -f
# Fetch sources from CVS, compile each module and install it
#</span>
export CVSROOT="username@corona.csc.fi:/fs/proj1/elmer/elmer-opensource"
export CVS_RSH="ssh"

modules="matc umfpack mathlibs elmergrid meshgen2d eio hutiter fem" 
cvs co $modules
for m in $modules; do
  cd $m ; ./configure --prefix=/opt &amp;&amp; make &amp;&amp; make install &amp;&amp; cd .. 
done
</pre>

<h2>Step by step instructions</h2>

<p>
First, check out the list of supported platforms and compilers to
get a feeling of the chances you have of compiling Elmer. If your
platform and compiler isn't listed, there is a chance that you won't
be able to compile Elmer.
</p>

<p>
Create a directory where you will compile the source. 
</p>

<pre>
&gt; mkdir -p /tmp/elmersrc
&gt; cd /tmp/elmersrc
</pre>

<p>
Decide where you want to install elmer. Good choices are
eg. /home/username or /opt/elmer, but /usr shouldn't cause any harm to
your system either. In this case, we will use /opt/elmer. The packages
will be installed under prefix as follows:
</p>

<pre>
.
|-- bin
|-- include
|   `-- elmer
|-- lib
`-- share
    |-- elmerfront
    |   |-- lib
    |   `-- tcl
    |       `-- images
    |-- elmerpost
    |   |-- help
    |   |-- lib
    |   `-- tcl
    `-- elmersolver
        |-- include
        `-- lib
</pre>

<p>Another thing to make clear before </p>

<h3>Compiling each package</h3>

<p>Get packages from CVS or with FTP (todo)e.</p>

<p>Compile everything</p>

<pre>
&gt; wget ftp://ftp.funet.fi/pub/sci/elmer/package-x.x.x.tar.gz (todo)
&gt; cd package-x.x.x
&gt; ./configure --prefix=/opt ; make ; make install
</pre>

<p>
If something fails (which is likely), there are several things you can
do. First of all, you might be able to make the code compile by <a
href="#manualcompilers">specifying the compilers manully</a>. Also,
another possible cause for compilation failure is that libraries are
missing or broken. You can help configure by <a
href="#manuallibs">manually specifying libraries</a> using
environment variables or command line arguments to ./configure. As a
last resort, you can specify your own <a href="automake-nano-howto.html#flags">compiler and
linker flags</a> to locate hard to find includes and libraries.

</p>

<a name="manualcompilers"/>
<h2>Manually specifying compilers</h2>

<p>To override the default compilers found by configure, you can use
the environment variables: CC, CXX, F77 and FC. For example, the following
will cause configure to use GNU compilers:</p>

<pre>
&gt; export CC=gcc
&gt; export CXX=g++
&gt; export FC=g95
&gt; export F77=g77
&gt; ./configure 
</pre>

<a name="manuallibs"/>
<h2>Manually specifying libraries</h2>

<p>
If you want to specify your own blas and lapack, you can eg.
</p>

<pre>
&gt; ./configure --with-blas="/home/username/lib/libblas.a"
</pre>

<p>
or use the environment variable:
</p>

<pre>
&gt; BLAS_LIBS="-L/some/convoluted/path/lib -lblas3.1.03"
</pre>

<p>
There are other variables and command line switches for specifying
other libraries as well. See ./configure --help for a detailed
listing.
</p>

<h2>Debugging</h2>

<p>By default, Elmer is compiled with optimization and without
debugging information. To get any meaningful debugging information,
you can either use the elmer-specific --with-debug switch for
configure, or manually specify the compiler flags before configure:</p>

<pre>
&gt; ./configure --with-debug
</pre>

<p>or</p>

<pre>
&gt; CFLAGS="-g" CXXFLAGS="-g" FFLAGS="-g" FCFLAGS="-g" ./configure
</pre>

<h2>Testing the build</h2>

<p>
The fem module contains a set of tests that can be used to test that
the solver really works. The tests can be invoked with <code>make
check</code>:
</p>

<pre>
&gt; cd fem
&gt; make check
-- cut --
testing: 1dtests          [PASSED]
testing: 1sttime          [PASSED]
testing: 2ndtime          [PASSED]
-- cut --
testing: streamlines      [PASSED]
testing: ThermalCompress  [PASSED]
testing: TimeAdapt        [PASSED]
Tests completed, passed: 52 out of total 52 tests
</pre>

<p>but also seperately from the tests subdirectory of the fem
module using the runtests script:</p>

<pre>&gt; cd fem/tests<br/>&gt; ./runtests PoissonBEM<br/>$ELMER_HOME undefined, setting it to ../src<br/>testing: PoissonBEM [PASSED]<br/>Tests completed, passed: 1 out of total 1 tests<br/></pre>

<p>If a test fails, a test.log file will be left in the test directory
for debugging purposes.</p>

<h2>MPI</h2>

<p>
There are two packages that need special care if you intend to use
the MPI version of elmer: mathlibs (parpack) and fem. If the mpi
libraries are not in a trivial place, then you will need
specify the location to the configure script. For this purpose there
are several command line arguments provided: </p>

<pre>
--with-mpi-dir     <span class="comment"># Specify a dir that contains--lib/, include/ and bin/</span>
--with-mpi-lib-dir <span class="comment"># Specify location of libmpi.{a|so}* or libmpich.{a|so}</span>
--with-mpi-inc-dir <span class="comment"># Specify location of mpif.h</span>
--with-mpi-bin-dir <span class="comment"># Specify location of mprun</span>
</pre>

<p>
Usually, the --with-mpi-dir will suffice, eg. on Sun:
</p>

<pre>./configure --with-mpi-dir=/opt/SUNWhpc/<br/></pre>

<p>
But sometimes there is a tricky situation (in this case, for 64 bit
mpi libs), and you will need something like this:
</p>

<pre>./configure --with-mpi-lib-dir=/opt/SUNWhpc/lib/sparcv9 \<br/>	--with-mpi-inc-dir=/opt/SUNWhpc/include/v9 <br/></pre>

<p>
A good way to look for MPI library directory is to `locate libmpi` or
compiling a simple test program with mpf90 (if provided) with verbose
compilation options to see which directories and libraries are used.
</p>

<h3>Testing MPI</h3>

<p>There are many different MPI environments, so it is difficult to
give a set of commands.</p>

<p>Basic MPICH2 style test</p>

<pre>&gt; cd tests/heateq-par<br/>&gt; mpirun -np 2 ../../src/ElmerSolver_mpi <br/></pre>

<p>On IBM, the solver executable is linked with mpxlf90, so no
mpirun/mprun is needed</p>

<pre>&gt; ../../src/ElmerSolver_mpi -nprocs 4 -pfile hosts.lst<br/></pre>

<h2>Common errors</h2>

<p>See the <a href="faq.html#compiling">FAQ</a>.</p>


<h2>Compilers known to work</h2>

<p>
<a name="compilers"/>
<table class="elmerTable">
<tbody><tr><td class="tableHead">Compiler</td><td class="tableHead">Remarks</td></tr>
<tr><td>GNU (gcc, g++, g77, <a href="http://g95.sf.net">g95</a>)</td><td>ok</td></tr>
<tr><td>Intel (icc, ifort)</td><td>ok</td></tr>
<tr><td>Pathscale (pathcc, pathCC, pathf90)</td><td>ok</td></tr>
<tr><td>Absoft</td><td>barely compiles</td></tr>
<tr><td>Sun Studio</td><td>ok</td></tr>
<tr><td>XL Fortran</td><td>ok</td></tr>
<!-- <tr><td>MS Visual Fortran</td><td>ok</td></tr> -->
</tbody></table>
</p>

<p>
A good rule is to try compiling everything with compilers of the same
vendor. The only exception is maybe ifort and pathscale, which work
fairly well together with the gnu c and c++ compilers.
</p>

<h2>Platforms known to work</h2>

<p>Elmer has been known to compile and function on the following platforms:</p>

<p>
<table class="elmerTable">
<tbody><tr><td class="tableHead">OS</td><td class="tableHead">Architecture</td><td class="tableHead">Working modules</td></tr>
<tr><td>Linux</td><td>x86, x86-64</td><td>S,P,F</td></tr>
<tr><td>Sun Solaris</td><td>sparcv7, sparcv9</td><td>S,P,F</td></tr>
<tr><td>IBM AIX</td><td>PPC</td><td>S</td></tr>
<tr><td>Apple OS X 10.3</td><td>PPC</td><td>S,P</td></tr>
<!-- <tr><td>Windows (cygwin)</td><td>x86</td><td>S,P</td></tr>
<tr><td>Windows (mingw32)</td><td>x86</td><td>S,P</td></tr> -->
</tbody></table>
</p>
<p>Legend: S=Solver P=Post F=Front</p>

<p></p>

<h2>Links:</h2>

<p><a href="automake-nano-howto.html">Automake nano-HOWTO</a></p>

</body>
</html>
