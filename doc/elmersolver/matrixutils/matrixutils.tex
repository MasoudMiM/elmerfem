\Chapter{Matrix manipulation utilities}
\noindent

\begin{versiona}
\section{\Idx{Dirichlet conditions}}

In finite element method there are two kinds of boundary conditions. 
The natural boundary condition that may be set by only affecting the r.h.s. of the 
equation and the essential boundary conditions where also the matrix needs to be tampered.
The latter ones are also called Dirichlet boundary conditions. The natural boundary conditions are often
more problem specific so the user is directed to the Models Manual for more details on them.

Technically the Dirichlet conditions in ElmerSolver are set through manipulating only the values
in the matrix rather than its structure. To be more specific, in setting the degree of freedom with index
$i$ the $i$:th row of the matrix is set zero, except for the diagonal which is set to be unity. When also
the r.h.s. of the equation is set to the desired value, the solution will satisfy the Dirichlet condition.
The Dirichlet conditions may be set to existing boundary elements. Additionally Dirichlet conditions may
be set for set of nodes that are created on-the-fly.

Usually the Dirichlet conditions are given at objects which have a lower dimension than the 
leading dimension in the geometry, i.e. for 3D problems values are usually fixed only at 2D faces.
However, it is possible also to set the conditions for the bodies also. This may be particularly 
useful when the condition is only conditional.

There is a handicap with this procedure which is that the symmetry of the original matrix will be lost.
This may affect the performance of linear system solvers. To ensure to symmetricity of the matrix equation there
are two remedies. Also the column may be zeroed and the known values may be subtracted from the r.h.s. 
The second option is to eliminate all the rows and columns related to the 
known values. This reduces the size of the matrix but of has an additional cost
as a secondary matrix is created and the values are copied into it. 

Sometimes the Dirichlet conditions should depend on other variables in a way which 
defined whether or not to set the conditions at all. For example, the temperature at a 
boundary should be defined only if the flow is inside the boundary. For outflow the definition
of the temperature is not physically justified. For this kind of purposes the user may give a condition 
that is a variable in itself. If this variable is positive the Dirichlet condition is applied,

\section{Periodic conditions}

Periodic BCs may be considered to be a special case of Diricghlet conditions where the fixed
value is given as linear combination of other unknown values.
The periodic boundary conditions in Elmer are very flexible. In fact they may even be antiperiodic. 


\section{Setting and computing nodal loads}

Similarly to the Dirichlet values one may also set nodal loads i.e. entries for the 
r.h.s. of the matrix equation. Generally there are good reasons to avoid the use of nodal loads
as they are mesh dependent. 
There are, however, some uses also for setting nodal loads. For example, in multiphysical couplings
sometimes it may be a good solution to transfer the forces directly in nodal form as this is 
the most accurate way to compute the forces resulting from the discrete system. 

It is possible to evaluate the nodal loads after the solution 
is computed. This however, requires that the original matrix $A_0$ that has not been 
eliminated for Dirichlet conditions is saved. Then the the nodal forces may be computed from
\begin{equation}
  f = A_0 x - b .
\end{equation}


%Toimii nyt myös StressSolve:n osalta myös transienttina tuo 'Constant Bulk System' olettaen, että r-ehdot eivät
%mökköile massaa ja vaimennusta. Eli jos vain r-ehdoissa on epälineaarisuuksia, eikä ole r-ehto vaimennuksia
%niin voipi laittaa vaikka nuo molemmat:

%Constant Bulk System = Logical True
%Linear System Refactorize = Logical False

%Mesh Update 1 DOFs = Equals Displacment 1
%Displacement Load 1 DOFs = Equals Stress 1


\section{Active and passive elements}

In Elmer it is possible to define certain areas of the modeled geometry
passive during the solution. This feature allows also deactivating and
reactivating of the elements. An element being passive means that its
contribution is not included into the global matrix equation. One
could, for example, model two separate bodies heated with different
heating power, and connect them with a third structure only after
suitable time has elapsed. This all could be modeled within a single
simulation.

The geometry of the whole system is meshed as usual, and the passive
elements are only omitted from the equations. The passive definition
is done solverwise and elementwise. The former means that, eg., the
temperature may be passive and the displacements active at the same
element. The passive property of elements is defined with a real valued
parameter with the name constructed from the name of the variable
followed by \texttt{Passive} in the \texttt{Body Force} section.
When the parameter obtains a value greater than zero the element is
passive. 


\section{Keywords for Matrix manipulation}
\end{versiona}

\sifbegin
  \sifitemnt{Solver}{solver id}
  \sifbegin
    \sifitem{Linear System Symmetric}{Logical True}
    Make the matrix symmetric by eliminating the known values from the r.h.s and zeroing the matrix entries.
    \sifitem{Before Linsolve}{"EliminateDirichlet" "EliminateDirichlet"}
    Creates a secondary matrix with a reduced size by eliminating Dirichlet 
    conditions and passing this to the linear system solver.
    \sifitem{Exported Variable i}{Varname Loads}
    This introduction of an additional variable with the suffix \texttt{Loads} 
    activates computation of the resulting loads.
  \sifend

  \sifitemnt{Boundary Condition}{bc id}
  \sifbegin
     \sifitem{Target Boundaries(n)}{Integer}
     The set of boundaries for which the Dirichlet conditions will be applied on.
     \sifitem{Target Nodes(n)}{Integer}
     Sets point conditions on-the-fly. These points refer to the obsolute indexing of the nodes.
     \sifitem{Target Coordinates(n,DIM)}{Real} 
      Ccoordinate values which are transformed into 
      nodal indexes corresponding to the nearest nodes at the time of first call. 
     Target groups defined by \texttt{Target Boundaries}, \texttt{Target Nodes}, and
     \texttt{Target Coordinates} should not reside in the same boundary condition definition.
     \sifitem{Varname}{Real}
     Each variable which has an equation that is solved for, may be set by giving its value 
     at the boundary conditions section. 
     If the variables are not listed in the keyword listing the user shoul also define the type which 
     is \texttt{Real}.
     \sifitem{Varname i}{Real}
     For multicomponent fields the Dirichlet condition may be set to each field separately.
     \sifitem{Varname Condition}{Real}
     The Dirichlet condition related to the variable is set active only if the condition is positive. 
     \sifitem{Varname Load }{Real} 
     Sets the goven value to the r.h.s. of the matrix equation related to the solution of the variable. Note that this
     value is a nodal quantity. The nodal loads are given exactly as the Dirichlet conditions except that 
     a string \texttt{Load} is attached to the name of the variable.
   \sifend
   The following keywords in the boundary condition section are used to control the 
   periodic boundary conditions.
   \sifbegin
     \sifitem{Periodic BC}{Integer}  
     This refers to the counterpart of the periodic boundary condition. This means that 
     periodic boundaries come in pairs, and for the other boundary you only need to give pointer to.
     \sifitem{Anti Periodic BC}{Integer}  
     The system may be also antiperiodic i.e. the absolute value is the same but the sign is different.
     \sifitem{Periodic BC Translate(3)}{Real}
     The periodic boundary is mapped to the other boundary by three different operations: 
     translation, rotatition and scaling. This generality is not usually needed and therefore 
     default value is used. For the translation vector the default is the vector that is obtained when 
     moving in the normal direction of the first boundary until the target boundary is hit. 
     If this is not desired the user may give another translation vector using this keyword.
     \sifitem{Periodic BC Rotate(3)}{Real}
     By default no rotation is performed prior to the mapping of values. This keyword may be used to give 
     the angles of rotation. 
      \sifitem{Periodic BC Scale(3)}{Real}
      By default there is no scaling performed prior to the mapping of values. This keyword may be used to give 
      a scaling vector if this is desired.
      \sifitem{Periodic BC Variable}{Logical True}
      The user should define the variables that are to be periodic in nature. 
      This is done by attaching their names into logical expressions following 
      the string \texttt{Periodic BC}.
    \sifend 

   \sifitemnt{Body Force}{body force id}
   \sifbegin
     \sifitem{Varname}{Real}
     The setting of Dirichlet conditions for the whole body follows the same logic as for the boundaries.
     When the body force is assigned to a body the values will be fixed as defined. 
    \sifitem{Varname Load }{Real} 
     Sets the goven value to the r.h.s. of the matrix equation related to the solution of the variable. Note that this
     value is a nodal quantity. The nodal loads are given exactly as the Dirichlet conditions except that 
     a string \texttt{Load} is attached to the name of the variable.
    \sifitem{Varname Passive}{Real}
     If this variable obtains a positive value the element is set passive and assembled for.
     Note that it is not possible to control components of vector valued
     variables separately. 
  \sifend
\sifend

\begin{versiona}
\bibliography{elmerbib}
\bibliographystyle{plain}
\end{versiona}

