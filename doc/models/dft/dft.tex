\begin{versiona}

\newcommand{\bor}{\boldsymbol{r}} % r - paikkavektori
\newcommand{\ala}{\scriptscriptstyle} % Isot kirjaimet viitteissä
\newcommand{\thalf}{\textstyle \frac{1}{2} \displaystyle} % Pieni puolikas


\chapter{Density Functional Theory}

\modinfo{Module name}{\Idx{DFTSolver}}
\modinfo{Module subroutines}{\Idx{Poisson}, \Idx{WaveFunctionSolver}, \Idx{ChargeDensitySolver}, xc}
\modinfo{Module authors}{Olli Mali, trad (xc)}
\modinfo{Document authors}{Olli Mali}
\modinfo{Document created}{10.12.2006}
\modinfo{Document edited}{18.12.2006}

\section{Introduction}

This is an instructional text for using Elmer solvers I created for
DFT calculations during the year 2006 while preparing my Master's Thesis
\cite{DI}. These Solvers are rather experimental and I would not
recommend their use for highly complicated problems. Nevertheless they
provide nice backbone for creating own DFT-solvers with finite
element method. 

\section{Theory}

In DFT, Kohn-Sham equations \cite{IEG, SCE} play central role. They are set of highly
nonlinear equations which define uniquely the exact ground state
charge density. From charge density the total
energy of the system in ground state can be calculated, which is
unfortunately not implemented in present code.

The Kohn-Sham equations have a form

\begin{equation} \label{KSyht}
  \begin{array}{rcl}
\Big( -\tfrac{1}{2}\Delta + V_{\ala EXT}(\bor) + V_{\ala C}[\rho(\bor)] 
+ V_{\ala XC}[\rho(\bor)] \Big) \psi_k(\bor) & = & \varepsilon_k \,
\psi_k(\bor) \\
\rho(\bor) & = & \sum_{k=1}^{N} |\psi_k(\bor)|^2 \quad , \\
\end{array}
\end{equation}
where KS-orbitals $\psi_k(\bor)$ are normalized, $\int \psi_k(\bor)^2
d\bor = 1$, for eack $k = {1, 2, \dots, N}$ . $V_{\ala EXT}$ is the
external potential caused by the nuclei,  $V_{\ala C}$ is the
non-interacting Coulomb potential and $V_{\ala XC}$ is the exchange
correlation potential that includes all the complicated many body
effects, at least approximates. Nice explanation from the widely used
Local Density Approximatio can be found from \cite{MBEWT}. Nonlinearity occurs in eigenvalue
problem, where the operator depends on the solution of the eigen problem.

\subsection*{Self-Consistent iteration}

The equations (\ref{KSyht}) are solved with self-consistent iteration
(fixed point iteration). In this iteration Coulomb and external
potentials are solved from Poisson equation. The iteration steps are
as follows:

\begin{enumerate}

  \item Begin with previous or initial guess for charge density $\rho^j$

  \item Solve new electric potential from Poisson equation,
    \begin{equation} \label{Poisson}
      -\Delta V^{j+1}(\bor) = \tfrac{1}{4 \pi}
      \rho^j(\bor)-\sum_{i=1}^M Z_i \; \delta(\bor - \bor_i) \quad ,
    \end{equation}
    where $\delta$ refes to Dirac's delta distribution (point load).
    
  \item Solve eigenvalue problem,
    \begin{equation}\label{oyht2}
      \Big( -\thalf \Delta + V^{j+1}(\bor)
      + V_{\ala XC}^{j+1} ( \bor ) \Big) \psi_k (\bor) = 
      \varepsilon_k  \psi_k(\bor) \quad , 
    \end{equation}
    where $V_{\ala XC}^{j+1}$ is calculated via some function $W$ from point
    values of charge density $\rho^j$. $V_{\ala XC}^{j+1}(\bor) = W(\rho^j(\bor)))$.
    
  \item Sum new charge density,
    \begin{equation}\label{vartih2}
      \rho^{j+1}(\bor) = \sum_{k=1}^N w_k \, \psi_k(\bor)^2 \quad ,
    \end{equation}
    where the weight coefficients $w_k$ depend on the numbers of
    electrons in orbitals. Extensive overview of calculation of
    molecular orbitals can be found from \cite{MQM, MM}.

\end{enumerate} 

The point load at the nuclei location requires, that \emph{exactly at each
nuclei there has to be a node} in the mesh. For the functionality of
the solvers no other requirements exists for the mesh or domain.

Unfortunately  convergence of this iteration procedure is not guaranteed. For
simple atoms (Z = {1,2,3,4}) code converges within any tolerance limits but for
more complicated molecules or atoms usually not. Sensible tolerances
were found to between $10^{-6}$ or $10^{-4}$.

\subsection*{Boundary Conditions}

In theory the zero level of the potential can be set arbitrarily and
often in practice one uses condition $ V(\bor) \rightarrow 0 $, when
$|\bor| \rightarrow \infty$. Of course in real calculations the domain
$\Omega$ is finite and we set, $V(\bor)=0$ if $\bor \in \partial
\Omega$. One also assumes $\Omega$ to be large enough, so that charge
density vanishes on the boundary, $\rho(\bor)=0$ if $\bor \in \partial
\Omega$, so we set $\psi_k(\bor)=0$ if $\bor \in \partial \Omega$.

In Kohn-Sham -equations in order to obtain positive definite
coefficient matrix on the left hand side of eigenvalue problem (\ref{KSyht}), one sets $ V(\bor) \rightarrow C $, when
$|\bor| \rightarrow \infty$. The constant $C$ has to be large enough,
so the eigenvalues are shifted positive. But too large value slowers the
convergence of the eigenvalue solver.


\section{Keywords}

From the structure of the self-consistent iteration it was natural to
divide the solution procedure for three solvers, Poisson solver,
eigensolver and charge density summation. For each solver some
keywords to control the solution procedure were added.

\subsection*{Poisson Solver}

Poisson Solver demands knowledge about the locations of the nuclei
and their atomic numbers. There has to be nodes in the mesh at the
nuclei locations, or else error will occur. Following example demonstrates how nuclei of
the water molecule with two atoms of atomic numbers $Z=1$ (Hydrogen) and
single with $Z=8$ (Oxygen) are set to the coordinates $(0.0, 0.0, 0.0)$
(Oxygen) and $(-1.43, 1.11, 0.0)$ and $(1.43, 1.11, 0.0)$ (Hydrogens).
The rows beginning with \verb+!+ are comments.

\begin{verbatim}

 !
 ! NOFnuclei is the number of nuclei in the structure.
 !

 NOFnuclei = Integer 3

 !
 ! NucleiTable is an array of the form 
 ! NucleiTable( NOFnuclei, 4 ) where each row 
 ! includes the information of one nucleus. 
 ! The colums are from left to right : 
 !
 ! atomic number, x-coordinate, y-coordinate and z-coordinate.
 !

 NucleiTable(3,4) =  Real 8.0  0.0  0.0  0.0 \ 
                          1.0 -1.43 1.11 0.0 \
                          1.0  1.43 1.11 0.0

\end{verbatim}

The self-consistent iteration requires heavy (under) relaxation to
avoid divergence. Relaxation means linear mixing of present solution
with previous one(s). It is possible to use \emph{Guaranteed Reduction Pulay
-method} \cite{rela,DI} where the mixing constants are calculated every time as a
solution of a minimization problem, it's sensible to begin GR Pulay
after some steps of linear mixing.

In following example the exponential relaxation scheme is changed to
GR Pulay after 5 steps or if the mixing parameter exceeds value 0.5 .
Use of constant mixing parameter instead of increasing one can be easily done by commenting out
the first four uncommented lines and removing the comment sign
\verb+!+ from following two lines.

\begin{verbatim}

  !
  ! Select the relaxation method used, possibilities are 
  ! constant mixing parameter a(k) = A or varying parameter 
  ! with scheme a(k) = C + 1- A * Exp( B * k )
  !

  Relaxation Method = String "Exponential mixing"
  Relaxation Parameter A = Real 1.0
  Relaxation Parameter B = Real 0.05
  Relaxation Parameter C = Real 0.005

  ! Relaxation Method = String "Constant mixing"
  ! Relaxation Parameter A = Real 0.01

  Start GRPulay after iterations = Integer 5
  Start GRPulay if relaxation factor is more than = Real 0.5	
 
\end{verbatim}

\subsection*{Eigenproblem Solver}

Eigenproblem solver demands knowledge about the type of exchange
correlation approximation used. Namely the expression of $W$ in third
self-consistent iteration step. In module \verb+xc.f90+ there are
several different formulae for LDA approximations. Some of them
include spin directions and are to be used with different solver
composition where KS-orbitals for up- and down-spins are calculated
separately.

\begin{verbatim}

 !
 ! Choose the type of the XC Potential, possible choises are:
 !   "None"
 !   "Perdew-Zunger"
 !   "Von Barth-Hedin" 
 !   "Gunnarsson-Lundqvist"
 !   "Perdew-Wang"
 !

 XC Potential type = String "Perdew-Zunger"

\end{verbatim}

\subsection*{Charge Density Solver}

Charge density solver demands knowledge about the number of
KS-orbitals to be summed and the weights of each orbital. These are
the $N$ and $w_k$'s in fourth self-consistent iteration step. In
following example one sets $N=5$ and $w_k=2$, for all $k =
{1,\dots,5}$.

\begin{verbatim}

 ! Define the number of eigenmodes included on the 
 ! calculation of charge density. Set weights for the 
 ! eigen states. By default they are all 1.

 Number of Eigenmodes Included = Integer 5
 Weights of Eigen States(5,1) = Real 2.0 2.0 2.0 2.0 2.0

\end{verbatim}

\verb+Weights of the Eigen States+ table has to be size $(N,1)$.
Naturally $N$ has to be equal or less for the number of eigenstates to
be solved in eigenvalue solver.


\begin{thebibliography}{99}

\bibitem{IEG} P. Hohenberg, W Kohn
\emph{Inhomogeneous Electron Gas}
Physical Review, Volume 136, Number 3B, 9 November 1964

\bibitem{SCE} W. Kohn, L. J. Sham,
\emph{Self-Consistent Equations Including Exchange and Correlation Effects}
Physical Review, Volume 140, Number 4A, 15 November 1965

\bibitem{MBEWT} M. P. Das, 
\emph{Density Functional Theory: Many-Body Effects Without Tears}
Proceedings of the Miniworkshop on "Methods of Electronic Structure Calculations", ICTP, Trieste, Italy 10 August - 4 September 1992

\bibitem{MQM} Peter Atkins, Ronald Frieman, \emph{Molecular Quantum Mechanics}
Oxford University Press Inc., Fourth edition 2005

\bibitem{MM} Andrew R. Leach,
\emph{Molecular Modelling}, 
Pearson Education Limited, Second edition 2001

\bibitem{rela} D. R. Bowler, M. J. Gillan, \emph{An effficient and robust technique for achieving self consistency in electronic structure calculations} Chemical Physics Letters 325 sivut 473-476 (2000)

\bibitem{DI}O. Mali, \emph{Kohn-Sham -yhtälöiden ratkaiseminen
  elementtimenetelmällä}, \\ Diplomityö, 19. syyskuuta 2006

\end{thebibliography}


\end{versiona}
