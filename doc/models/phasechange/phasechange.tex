\chapter{Phase Change}

\modinfo{Module name}{\Idx{PhaseChangeSolve}}
\modinfo{Module subroutines}{PhaseChangeSolve}
\modinfo{Module authors}{Peter Råback, Jussi Heikonen, Juha Ruokolainen}
\modinfo{Document authors}{Peter Råback}
\modinfo{Document created}{22.10.2004}
\modinfo{Document edited}{28.4.2006}


\section{Introduction}


The boundary which separates a liquid and solid phase of a material is called 
a phase change or \Idx{Stefan boundary}. 
This subroutine defines the position of the phase change boundary.
The phase change problem may occur for example in crystal growth and 
casting processes. 

Phase change problems may be modeled using a fixed grid or alternatively distorting the grid
so that the phase change boundary surface is exactly described by the computational mesh. 
Elmer has an internal fixed grid phase change model where the phase change is modelled
by modifying the definition of heat capacity.
This method is not limited by topological constraints but its accuracy 
may be questionable. If the 
phase change occurs within very sharp temperature interval
the current method where the phase change surface is set exactly 
should be preferred,

The current methodology is limited into two dimensional cases
where the phase change surface is nearly aligned with either of the 
coordinate axis.


\section{Theory}

The phase change from solid to liquid occurs at the 
\Idx{melting point} $T_m$. At the boundary the temperatures of the 
liquid and solid are therefore equal to that. 
The phase change results to a change in the internal energy
known as the latent heat $L$. 

The \Idx{latent heat} makes the diffusive heat flux over the boundary discontinuous 
and results to the so called Stefan condition
\begin{equation} 
\label{e:stefan}
L\rho \Vec{v}  \cdot \Vec{n} =
(\kappa_{s}\nabla T_{s}-\kappa_{l}\nabla T_{l})\cdot \Vec{n},
\end{equation}
where $\Vec{n}$ is the normal of the phase change boundary, 
$\Vec{v}$ is the velocity of the phase change boundary,
$\rho$ is the density of the solid 
and $T_{s}$ and $T_{l}$ are the temperatures of the solid and liquid phases,
and $\kappa_{s}$ and $\kappa_{l}$ are the thermal 
conductivities, respectively.
In steady state the velocity of the phase change boundary should be equal to pull velocity,
$\Vec{v}=\Vec{V}$ (bulk velocity of the solid phase).


\subsection{Steady state algorithm} 

In steady state case the basic algorithm is based mainly on geometrical ideas.
First the heat equation for temperature $T$ is solved by using a flux 
condition for the interface
\begin{equation}
  q =  L \rho V_n . 
\end{equation}
Thereafter the next approximation for the 
phase change surface may be found by going trough each element and 
creating a list of line segments $E_j$ on the isosurface.
This is basically the zero level-set of the field $T-T_m$.
Each line segment is defined by two coordinate $\Vec{x}_{j,1}$ and $\Vec{x}_{j,2}$.
The surface is then updated by mapping the current phase change surface to the 
line segments. For the moment a $N^2$ algorithm is used for the mapping. For larger
cases a more robust search algorithm might be implemented. 

For example, if a free surface is almost aligned along the x-axis,
then for a node $(x_i,y_i)$ on the boundary the 
proposed change of the point $i$ in the 
y-direction is 
\begin{equation}
  s_y = (y_{j,1} - y_i) +  ( x_i - x_{j,1}) \frac{y_{j,2}-y_{i,1}}{x_{j,2}-x_{j,1}}
\end{equation}
assuming that $x_i \in [x_{j,1},x_{j,2}]$ while $s_x = 0$.


In many cases the simple geometrical search algorithm converges
very slowly. The reason is the explicit character of the algorithm that fails to account
for the change in the temperature field caused by the moving phase change boundary.
This limitation may be partially overcome using suitable under- or over-relaxation. 
This relaxation parameter may also be tuned during the iteration using lumped 
quantities such as the proposed change in the volume of the phases
that may be expressed as
\begin{equation}
  U = \int_A \Vec{s} \cdot \Vec{n} \, dA . 
\end{equation}
The proposed volume changes form a series, $U^{(0)}, U^{(1)}, \ldots, U^{(m-1)}, U^{(m)}$.
Assuming that the series is a geometric one we may estimate the required relaxation
factor that would give the correct phase change boundary at just one iteration,
\begin{equation}
  c^{(m)} = c^{(m-1)} \frac{U^{(m-1)}}{U^{(m-1)}-U^{(m)}}.
\end{equation} 
In numerical tests this formula was found occasionally to overshoot and 
therefore a less aggressive version is used instead,
\begin{equation}
  c^{(m)} = c^{(m-1)} \frac{1}{2}\frac{U^{(m-1)}+U^{(m)}}{U^{(m-1)}-U^{(m)}}.
\end{equation} 
The use of the lumped model requires that the temperature field is described accurately enough.
To ensure numerical stability the factor $c$ should have a upper and lower limits.
After the factor has been defined the suggested displacements are simply scaled with it,
$\Vec{s}' = c \Vec{s}$.

It is also possible to accelerate the solution locally using a Newton kind of iteration.
If the basic algorithm has already been applied at least twice we may estimate the sensitivity of the 
local temperature to the moving interface and using this information to estimate a new change,
\begin{equation}
  s^{(m)} =   \frac{T_m - T^{(m)}}{T^{(m)} - T^{(m-1)}} s^{(m-1)} .
\end{equation}
This algorithm might be a better option if the 
phase change surface is such that there is not much correlation between the displacements at the
extreme ends. However, the algorithm may be singular if the isotherms of consecutive iterations
cross. Any point $i$ where $T^{(m-1)}_i \approx T^{(m)}$ leads to problems that
may be difficult to manage. This handicap may rarely limit the usability of the otherwise robust and
effective scheme.


\subsection{Transient algorithm}

In transient case the interface is set to be at the melting point when 
solving the heat equation. From the solution a heat flux is then obtained from
\begin{equation}
\Vec{q} = \kappa_{s}\nabla T_{s}-\kappa_{l}\nabla T_{l}.
\end{equation}
Now this heat flux is assumed to be used for the melting of the 
solid phase into liquid phase. 
Assuming again that the phase change boundary is mapped to the new position
moving it only in the $y$-direction we get 
from equation~(\ref{e:stefan}) the velocity in the $y$-direction,
\begin{equation}
  \rho L n_y ( v_y - D_v \nabla^2 v_y) 
= \Vec{q} \cdot \Vec{n}.
\end{equation}
Here an artificial diffusion $D_v$ has been added since the algorithm otherwise 
is prone to numerical oscillations. In order for the diffusion not to affect the results significantly 
it must fulfil the condition $D_v << h^2$ where $h$ is the size of the 1D elements. 

The corresponding displacement is easily obtained from multiplication
$u_y = v_y \, dt$, where $dt$  is the timestep.
However, in the current formulation this is also done using the 
Galerkin method since the possibility of an additional diffusion factor
is included. Therefore the equation is of the form,
\begin{equation}
  \Der{u_y}{t} - D_u \nabla^2 u_y = v_y.
\end{equation}

In continuous processes the triple point may be used to define the 
pull velocity so that at the point the solution of the equation vanishes.
In case the pull occurs in the $y$-direction this 
means that $V_y = v_y$.

The transient algorithm is ideally suited for relatively small time-steps
where the change in the position is small compared to the other dimensions of the problem.
Otherwise the transient algorithm may result to spurious oscillations.
However, often the timestep size is most severely limited by the flow computations. 
Therefore it may be possible to boost the convergence towards the true operation
regime by multiplying the suggested change by a constant factor. 



\subsection{Hybrid algorithm}

The transient and steady-state algorithm are difficult to apply to cases 
with many different time-scales. The steady-state algorithm converges rapidly to the 
desired shape, however it does not have the inertia that would resist temporal 
fluctuations. The transient algorithm, on the other hand, requires too many iterations 
to be feasible. For that aim we study hybrid algorithms that would combine some of the 
best properties of both methods.

The desired form of the hybrid algorithm would be based on a  
\Idx{Robin boundary condition} for the temperature. 
\begin{equation}
  q_n = L\rho V_n + g (T - T_m).
\end{equation}
This reduces to a Dirichlet condition when $g \rightarrow \infty$ and
to the flux condition when $g=0$. On the other hand the Stefan condition
may be expressed as 
\begin{equation}
  q_n = L\rho ( V_n - v_n ),  
\end{equation}
We use the following approximations
\begin{equation}
  v_n \approx \frac{dn}{dt} \approx \frac{1}{dt} \frac{1}{\Der{T}{n}} ( T - T_m ) .
\end{equation}
The normal derivative of temperature may be approximated by 
\begin{equation}
  \Der{T}{n} = \frac{\kappa\Der{T}{n}}{\kappa} \approx \frac{L \rho V_n }{p \kappa}
\end{equation}
where $p$ is the fraction of the heat flux that goes into solidification. 
Combining the above yields,
\begin{equation}
  q_n = L \rho V_n + g (T_m - T)
\end{equation}
where 
\begin{equation}
  g = \frac{p \kappa}{dt \, V_n} 
\end{equation}
which is an equation of the desired form.
For $dt \rightarrow \infty$ this
retains the original steady state algorithm while for shorter timesteps the 
inertia of the interface is naturally produced. 

After the heat equation with the Robin condition has been solved there
is possible two ways of tuning the interface positions. The first one would use
the geometric ideas of the steady state algorithm. However, the instantaneous 
temperature field may be such that there is no well defined temperature 
isoline that would define the interface position. Therefore
we rather use the transient algorithm to update the position. 
After the solution the disbalance in the heat flux may be computed from 
\begin{equation}
  dq_n = g (T_m - T)
\end{equation}
and the interface velocity from
\begin{equation}
  v_n = \frac{g}{L \rho} (T - T_m).
\end{equation}
Once the normal velocity $v_n$ is computed one may proceed as in the 
transient case. 

The nice property of the hybrid algorithm is that the proposed interface velocity
should not be sensitive on the coefficient of the Robin boundary condition. 
This way the coefficient may be partly chosen so that the convergence 
is optimal. 



\section{Applicable cases and limitations}

The method has some limitations which are described below
\begin{itemize}
\item Limited to 2D and axisymmetric cases.
\item Phase change surface must be nearly aligned with either of the main axis. 
To be more precise the boundary must in all instances be such that for each coordinate there
is only one point on the boundary.   
\item Melting point is assumed to be constant 
\item It should be noted that the solver only gives the position of the phase change 
boundary. In order to modify the whole geometry a mesh update solver must 
be applied. 
\end{itemize}


\section{Keywords}

\sifbegin
\sifitemnt{Solver}{solver id}
\sifbegin
\sifitemnt{Equation}{String "Phase Change"}
\sifitem{Procedure}{File "PhaseChangeSolve"\ "PhaseChangeSolve"}
The subroutine that performs the phase change analysis.
%
\sifitem{Variable}{String PhaseSurface}
The variable for the PhaseSurface coordinate.
This may be of any name as far as it is used consistently also elsewhere.
\sifitem{Variable DOFs}{Integer 1}
Degrees of freedom for the free surface coordinate, the default.
%
\sifitem{Phase Change Variable}{String}
By default the phase change analysis uses \texttt{Temperature} as the 
active variable. The analysis may be performed also to any other scalar
variable given by this keyword
%
\sifitem{Nonlinear System Relaxation Factor}{Real}
Giving this keyword triggers the use
of  relaxation in the phase change solver.
Using a factor below unity may sometimes be required to achieve convergence.
Relaxed phase change variable is defined as follows:
$$
 u^{'}_i = u_i + \lambda s_{i-1},
$$
where $\lambda$ is the factor given with this keyword. The default value for the relaxation factor
is unity. If using the lumped model to accelerate the solution the final relaxation factor will the product of 
the two.
%
\sifitem{Long Transition Timestep}{Real}
There are three different regimes that may be used. This one
defines the timestep at which the steady algorithm changes to 
medium timestep algorithm.
%
\sifitem{Short Transition Timestep}{Real}
This keyword
defines the timestep at which the medium timestep algorithm is switched to
short timestep algorithm. 
%
\sifitem{Medium Timestep Algorithm}{String}
The medium timestep algorithm. The options are ``steady'', ``hybrid'', and ``transient''.
\sifitem{Short Timestep Algorithm}{String}
The same options as the previous keyword.
\sifend
%
Some variables have a function only in steady state while others 
relate to the transient case. Below are the 
steady-state parameters for the  \texttt{Solver} section.
%
\sifbegin
\sifitem{Nonlinear System Newton After Iterations}{Integer}
The local Newton type of iteration may be set active after 
a number of iterations given by this keyword.
%
\sifitem{Nonlinear System Newton After Tolerance}{Real}
The Newton type of iteration may also be activated after a sufficiently small change in the norm.
This keyword gives the limit after which Newton iteration is triggered on. 
%
\sifitem{Lumped Newton After Iterations}{Logical}
The phase change solver may be accelerated pointwise, or by using a lumped model to determine
an optimal relaxation factor for the whole solution. This keyword activates the lumped model
procedure. 
%
\sifitem{Lumped Newton Limit}{Real}
The lumped approach sometimes gives too high or too small relaxation factors. 
This may happen particularly at the very vicinity of the solution where the 
approximation errors have a greater effect. 
%
\sifitem{Triple Point Fixed}{Logical}
This keyword enforces the triple point to be fixed. Depending on the type of algorithm this
may mean different things. For the steady algorithm this means that the temperature used for
finding the isotherm is set to be the temperature of the triple point. Hence the 
isoterm will travel through the triple point. In the transient algorithm this means that 
the interface velocity is tuned so that the velocity at the triple point is zero.
%
\sifitem{Use Absolute Norm for Convergence}{Logical}
The steady-state solver returns the maximum phase change update as the 
norm and therefore this
flag should be set \texttt{True}.
The transient solver gives the norm of the finite element solution in the
usual manner. 
\sifend
%
The following keywords may be defined in the transient algorithm.
\sifbegin
\sifitem{Pull Rate Control}{Logical}
In transiet case the pull rate may be set so that the triple point remains at a fixed 
position. The feature is activated setting this keyword \texttt{True}.
%
\sifitem{Velocity Relaxation Factor}{Real}
The relaxation factor for the crysrallization velocity field. 
%
\sifitem{Velocity Smoothing Factor}{Real}
The velocity diffusion factor of the interface, $D_v$.
%
\sifitem{Transient Speedup}{Real}
The factor at which the change in the boundary position is changed in the transient 
case. This may be used to speedup the transient convergence. 
%
\sifitem{Nonlinear System Max Iterations}{Integer}
In case the pull-rate control is used the phase change algorithm may have
to be solved several times in order to define the consistent pull-rate. 
This keyword gives the maximum number of iterations.
The steady state algorithm is solved by just one sweep.
%
\sifitem{Nonlinear System Convergence Tolerance}{Real}
The tolerance for terminating the transient algorithm.
\sifitem{Stabilize}{Logical}
The transient algorithm may require stabilization 
which decreases the oscillations of the solution. 
%
\sifend
%
\sifitemnt{Body}{body id}
\sifbegin
\sifitemnt{Solid}{Logical}
\sifitem{Liquid}{Logical}
The solver requires information on which of the materials in the system is solid
and which is liquid. Currently the solver assumes that both the liquid and 
solid is uniquely defined. 
\sifend

\sifitemnt{Material}{mat id}
\sifbegin
\sifitem{Melting Point}{Real}
The melting point is the temperature at which the transition form solid to liquid occurs.
The melting point is assumed to be constant.
\sifitem{Heat Conductivity}{Real}
In a transient case the heat conductivities of the both materials must be given.
\sifitem{Density}{Real}
Density may be needed in the computation of the surface normals. 
By default, the normals point out from the denser of the two materials.
\sifitem{Pull Velocity i}{Real}
For the transient algorithm the pull velocity of the boundary may be given
with this keyword. 
%
\sifitem{Latent Heat}{Real}
The latent heat is the specific internal energy related to the phase change.
The latent heat may also be a variable. 
\sifend
%
\sifitemnt{Boundary Condition}{bc id}
\sifbegin
\sifitem{Body Id}{Integer}
The phase change solver operates usually on a boundary of a two-dimensional 
domain. Technically the equation on the boundary is treated in a normal finite element
manner and therefore the boundary must be defined to be the body where the 
equation is to be solved. Usually this would be the next free integer in the
list of bodies. 
\sifend
The module also includes subroutines \texttt{PullRate} and \texttt{PullPosition}
that may be used to give
boundary conditions for the mesh update solver.
These subroutines relate to transient case. 
The syntax of the subroutines is as the following,
%\sifbegin
\ttbegin
Mesh Update 2 = Variable Coordinate 1
  Real Procedure "PhaseChangeSolve" "PullPosition"
\ttend
and 
\ttbegin
Convection Velocity 2 = Variable Coordinate 1
  Real Procedure "PhaseChangeSolve" "PullRate"
\ttend
%\sifend
For the steady state case the heat equation often requires the 
heat flux as a boundary condition. For this there is also a precompiled 
subroutine that may be activated by the following lines in the command file,
%\sifbegin
\ttbegin
Heat Flux BC = Logical True
Heat Flux = Variable Coordinate 1
  Real Procedure "PhaseChangeSolver" "MeltingHeat"
\ttend
%\sifend
\sifend





\bibliography{elmerbib}
\bibliographystyle{plain}

