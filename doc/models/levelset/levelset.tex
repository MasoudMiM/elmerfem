
\chapter{Level-Set Method}\label{Level-Set}

\modinfo{Module name}{\Idx{LevelSet}}
\modinfo{Module subroutines}{\Idx{LevelSetSolver}, \Idx{LevelSetDistance}, \Idx{LevelSetIntegrate}, 
\Idx{LevelSetCurvature}, \Idx{LevelSetTimestep}}
\modinfo{Module authors}{Peter Råback, Juha Ruokolainen}
\modinfo{Document authors}{Peter Råback}
\modinfo{Document created}{5.4.2006}
\modinfo{Document edited}{28.4.2006}

 
\section{Introduction}

There are a number of problems involving \Idx{free surface}s in continuum mechanics.
There are two main strategies to solve them using the finite element method:
\Idx{Lagrangian} and \Idx{Eulerian} approach. 
In the Lagrangian approach the free surface is solved exactly so that 
it is also an interface between the individual elements. This 
requires that the computational mesh is distorted in a way that 
this is possible. However, often the changes in geometry may be too drastic or
even the whole topology may change and the Lagrangian approach is no longer feasible.
The Eulerian approach describes the interface in a fixed mesh using 
some additional variable to describe the position of the interface. 
One possible Eulerian technique is the \Idx{level-set method} (LSM). 

In the level-set method the free surface is given as a zero level-set of a
higher dimensional variable. E.g. for 2D surfaces the level-set function is 
defined in 3D space. The level-set function is usually defined to be a \Idx{signed distance} 
so that inside the domain it obtains a positive value and outside a negative value.
The changes in the value of the level-set function mean also that 
the interface changes the position. 

This module includes several different subroutines that may be used 
when applying the level-set method.
Currently there is no \Idx{reinitialization} strategy for 3D problems. Also some 
other procedures are not fully optimized for the best performance. Therefore
the current implementation is best applied to quite simple 2D problems.


\section{Theory}

The interface is defined by a marker function $\phi$ so that 
at the interface $\phi=0$, inside the fluid of interest $\phi > 0$ and
elsewhere $\phi < 0$. The interface is update by solving the equation
\begin{equation}
\Der{\phi}{t} + \Vec{u} \cdot \nabla \phi = a
\label{eq:levelset1}
\end{equation}
where $\Vec{u}$ is the convection field and $a$ is the normal 
flux on the interface. 
It is quite challenging to solve the differential equation above
without diffusion effects playing a significant role. It is advisable to
use 2nd order time-discretization schemes and short timesteps. 
More precisely, the Courant number $C=|\vec{u}|dt/h$ should be below unity.

It is desirable that the absolute value of function equals the shortest 
distance to the zero level-set. However, as the level-set function 
is advected this property may be gradually lost. Therefore a process called 
reinitialization may be evoked. In 2D the reinitialization may be easily done 
by geometric procedure. First the zero level-set is formed by going through all
the elements and finding the line segments that make the zero level-set. Then 
the minimum distance of all the nodes is computed by a brute-force search.  
Assuming there are $N$ nodes and $M$ line segments the search algorithm is 
$N\times M$ which is quite acceptable complexity for small cases but 
may become computationally costly in large cases.

The line segments may be assumed to go with the flow and thereby 
they form an on-the-fly Lagrangian mesh. 
Therefore it is also possible to advect the line segments when the velocity 
field is given since for any node $\Vec{r} =\Vec{r} + \Vec{u}\,dt$.
After the advection the shortest distance is
computed. In the case of no advection the sign of the distance is inherited from the 
original level-set function. However, when the level-set is also convected the
sign must be deduced from the geometric information as well. In the current
implementation each line segment is given a flag telling on which side of the element
the fluid of interest is located. This directional information is then used in giving the
correct sign for the distance.

The volume of the fluid of interest in the level-set method may be 
computed over an integral that obtains a value one inside the fluid and 
value zero outside the fluid. The \Idx{Heaviside function} 
$H(\phi)$ has this desired property.
However, as the interface does not 
follow the element division the numerical integration 
would result into spurious fluctuations depending on the position of the interface
within the elements. To obtain a smooth behavior the 
Heaviside function must be regularized:
\begin{equation}
  H_\alpha(x) = \begin{cases} 
    0, & x < \alpha \\
    \frac{1}{2}\left(1+\sin \left(\frac{x}{a}\frac{\pi}{2} \right) \right), & |x| \leq \alpha \\
    1, & x > \alpha , 
  \end{cases}
\end{equation}
where $\alpha$ is the interface bandwidth which equals typically the size of a few elements.
Now the volume (area in 2D) is obtained by the integral
\begin{equation}
  V = \int_\Omega H_\alpha (\phi) \, d\Omega .
  \label{eq:levelsetvolume}
\end{equation}
After the same regularization the area (length in 2D) may be obtained from the 
integral
\begin{equation}
  A = \int_\Omega \delta_\alpha (\phi)|\nabla\phi|  \, d\Omega
  \label{eq:levelsetarea}
\end{equation}
where the \Idx{delta function} is 
\begin{equation}
  \delta_\alpha(x) = \begin{cases} 
    0, & |x| > \alpha \\
    \frac{1}{2\alpha} \cos \left ( \frac{x}{a}\pi \right), & |x| \leq \alpha. 
  \end{cases}
\end{equation}

The information obtained by the above integrals may be used to improve the 
volume conservation of the level-set advection. If the initial volume $V_0$ is known
the level-set function may be given a small correction by 
\begin{equation}
  d\phi = \frac{V_0 - V}{A}.
  \label{eq:levelsetcorrect}
\end{equation}
This correction has no physical basis but it may be argued that a consistently
small update of the level-set function has a minor effect in overall results. 
It is more important that the volume is conserved since the 
history information of the shape of a bubble is 
gradually lost while the errors in volume are never forgotten. However, if the 
fluid of interest is divided into several parts this kind of overall correction
does not have any justification since it could ruin the volume 
balance between the different domains.

The problems in accuracy may be partially resolved by using an optimal 
timestepping strategy. This may be achieved by looking at the velocity field 
around the active boundary. The normal velocity may be obtained by 
$u_n=\Vec{u}\cdot\nabla\tilde{\phi}$. Registering the maximum velocity at 
band the timestep may be limited so that the Courant number is bound.
If $ds$ is the maximum allowed change in the 
position of the zero level-set the corresponding time-step is
$dt = ds / \max |u_n|$. 

In the Eulerian approach to the free surface 
problems the \Idx{surface tension} force must be smeared out to a volume force
within a narrow band from the interface. The transformation is achieved by 
using a regularized delta function,
\begin{equation}
  \int_\Gamma \sigma \kappa \, d\Gamma = \int_\Omega \sigma \kappa \delta(\phi) 
  \nabla \phi \, d\Omega,
\end{equation}
where $\sigma$ is the surface tension
coefficient and $\kappa$ the \Idx{curvature} of the interface given by 
\begin{equation}
  \kappa = \nabla \cdot \frac{\nabla \phi}{|\nabla \phi|}.
\end{equation}
In the finite element approach the force cannot be estimated directly since
it involves three derivatives of the level-set function. Therefore we must solve
an additional equation for the \Idx{curvature} $\kappa$,
\begin{equation}
  \kappa - c_\kappa \nabla^2 \kappa = \nabla \cdot \nabla \tilde{\phi} .
  \label{eq:levelsetcurvature}
\end{equation}
Here $c_\kappa$ is an ad'hoc diffusion coefficient that may be used to 
smooth the resulting curvature field.
Otherwise the sharp corners may result to very large peak values of the 
curvature. 
The weak formulation of the above equation introduces surface fluxes 
which are evaluated from the normal derivatives of the level-set function.
Once the level-set function and the corresponding curvature have been computed 
the surface tension may be applied as a volume force in the flow equations. 


\section{Keywords}

\subsection*{LevelSetSolver}

This subroutine uses the finite element method to solve the equation
(\ref{eq:levelset1}). The implementation is valid in 2D, 3D and axisymmetric 
problems.

\sifbegin
\sifitemnt{Solver}{solver id}
\sifbegin
\sifitemnt{Equation}{String "Level Set Solver"}

\sifitem{Procedure}{File "LevelSet"\ "LevelSetSolver"}
The subroutine for advecting the level-set function.

\sifitem{Variable}{String "Surface"}
The name of the level-set function. This may be chosen freely as long as it is used
consistently elsewhere.

\sifitem{Stabilize}{Logical}
Either stabilization or bubbles are used to solve the convection problem. This
flag enforces the stabilization on. 
\sifend

\sifitemnt{Material}{mat id}
\sifbegin
\sifitemnt{LevelSet Velocity 1}{Real}
\sifitemnt{LevelSet Velocity 2}{Real}
\sifitem{LevelSet Velocity 3}{Real}
The velocity field that advects the level-set function. This may be a constant field or also 
something computed with the Navier-Stokes solver. 
\sifend

\sifitemnt{Body Force}{bodyforce id}
\sifbegin
\sifitem{LevelSet Flux}{Real}
The flux (i.e. the normal velocity) of the level-set function. 
\sifend
\sifend


\subsection*{LevelSetDistance}

This solver uses the geometric information to compute the signed distance
and, if desired, to advect the zero level-set at the same time.
This solver does not solve an equation and hence it does not need to have a 
variable of its own. The solver is limited to 2D and axisymmetric cases.

\sifbegin
\sifitemnt{Solver}{solver id}
\sifbegin
\sifitemnt{Equation}{String "Level Set Distance"}

\sifitem{Procedure}{File "LevelSet"\ "LevelSetDistance"}
The subroutine for renormalizing (and advecting) the level-set function.

\sifitem{LevelSet Variable}{String "Surface"}
This keyword should refer to the name of the level-set variable that 
is used to advect the field. The default is \texttt{Surface}.

\sifitem{Exported Variable 1}{String "Surface"}
In case the level-set variable does not exist it must be introduced.
This may be the case if this subroutine is also used for advecting the 
level-set function.

\sifitem{LevelSet Convect}{Logical}
Whether to also convect the level-set function.
Default is \texttt{False}.

\sifitem{Extract Interval}{Integer}
When this function is used to extract the zero level-set function the 
user may choose the interval how often this is done. The default is 
one. Just extracting the level-set may be useful if one just wants to save
the zero level-set without activating reinitialization.

\sifitem{Reinitialize Interval}{Integer}
When this function is used to reinitialize the level-set function the 
user may choose the interval how often this is done. The default is 
one but often this results to excessive smoothening of the level-set field. 
If reinitialization is asked the zero level-set will also be automatically extracted.

\sifitem{Reinitialize Passive}{Logical}
If this keyword is set \texttt{True} the reinitialization is not applied to the level-set field.
The field is only used to extract the zero level-set and compute the corresponding signed distance 
but this information is not used to change the original field.

\sifitem{Narrow Band}{Real}
In case that also the convecting is done by this solver there is the possibility to introduce 
a narrow band which gives the distance at within the level-set function is recomputed. 
Default is $\infty$. Typically this should be larger that 
the level-set bandwidth $\alpha$ used to evaluate surface integrals.

\sifitem{Filename}{File}
The zero level-set may also be saved. It consists of a number of line segments that are
defined elementwise. The results from the file may be used for visualization, for example,
in MatLab. If no filename is given the zero level-set is not saved. 

\sifitem{File Append}{Logical}
If the above is given this flag enforces the results to be appended on the same 
file rather than writing over the old results.
\sifend

\sifitemnt{Material}{mat id}
\sifbegin
\sifitemnt{LevelSet Velocity 1}{Real}
\sifitem{LevelSet Velocity 2}{Real}
If also convection is accounted in this solver the convection field
is given by the above expressions. Currently it is not possible to give the desired 
surface flux as it is not uniquely defined for the line segments having different normals
even at the same point.
\sifend
\sifend


\subsection*{LevelSetIntegrate}

This subroutine computes the integrals (\ref{eq:levelsetvolume}) and 
(\ref{eq:levelsetarea}).  
In addition of computing volume and surface integrals this
subroutine may also be used to set the absolute level of the level-set function
so that volume is conserved using equation (\ref{eq:levelsetcorrect}).
The implementation is valid in 2D, 3D and axisymmetric 
problems.

\sifbegin
\sifitemnt{Solver}{solver id}
\sifbegin
\sifitemnt{Equation}{String Level Set Integrate}

\sifitem{Procedure}{File "LevelSet"\ "LevelSetIntegrate"}
The subroutine for computing the integrals.

\sifitem{LevelSet Variable}{String "Surface"}
This keyword gives the name of the level-set function used for computing the 
integrals. The default is \texttt{Surface}.

\sifitem{LevelSet Bandwidth}{Real}
When computing the values over the domain the interface is treated a 
with smooth functions. How smooth the functions are depends on the
value of this keyword. Typically the bandwidth should be such that the 
interface is extended over a few elements. 

\sifitem{Conserve Volume}{Logical}
The volume in the level-set formulation is not conserved by construction. 
To that end the level of the level-set function may be tuned so that 
conservation is enforced. The default is \texttt{False}. 

\sifitem{Conserve Volume Relaxation}{Real}
If conservation is enforced it may be done only partially as there are
inaccuracies in the avalution of the volume integrals. The default is one.

\sifitem{Initial Volume}{Real}
If conservation is enforced the target volume is given by this keyword.
Otherwise the volume from the first timestep is used as the target value.

\sifend
\sifend



\subsection*{LevelSetCurvature}

This solver computes the value of the curvature give the level-set function using
equation (\ref{eq:levelsetcurvature}).

\sifbegin
\sifitemnt{Solver}{solver id}
\sifbegin
\sifitemnt{Equation}{String Level Set Curvature}

\sifitem{Procedure}{File "LevelSet"\ "LevelSetCurvature"}
The subroutine for computing the curvature.

\sifitem{Variable}{String "Curvature"}
The name of the curvature variable.

\sifitem{LevelSet Variable}{String "Surface"}
This keyword gives the name of the level-set function used for computing the 
integrals. The default is \texttt{Surface}.

\sifitem{Curvature Diffusion}{Real}
Artificial diffusion may be used to control the singularities of the 
curvature field around sharp corners. The default is zero.

\sifitem{Curvature Coefficient}{Real}
A constant that is used to multiply the curvature field before the solver is 
exited. This may be used for example to change the sign of the curvature if the 
material of interest is on the outside and not an the inside.

\sifitem{LevelSet Bandwidth}{Real}
The delta function for the volume force may be applied to the curvature field also within this 
solver directly. This has the disadvantage that the evaluation is done at nodal points 
rather than at the integration points. However, if the flow solver used may not be modified this 
may be the best alternative. If this keyword does not exist, no delta function is used to 
filter the curvature field. 

\sifend

\sifitemnt{Boundary Condition}{bc id}
\sifbegin
\sifitem{Levelset Curvature BC}{Logical}
The weak formulation of the curvature computation results to boundary integrals that should be set
at all surfaces where the curvature is computed.
\sifend
\sifend


\subsection*{LevelSetTimestep}

The solution of the level-set function is accurate only if 
the timestep is limited so that the local Courant number along the zero level-set
is in the order of one or smaller. 
A tailored function for setting the timestep is given in this module.
This solver assumes that the
level-set variable is named \texttt{Surface} and that this variable is related to 
some solver. The velocity needed for setting the timestep should be given by the 
keywords \texttt{LevelSet Velocity i}, where \texttt{i=1,2,3}.

\sifbegin
\sifitem{Simulation}{}
The function call and the needed parameters reside in the \texttt{Simulation} block
of the command file.

\begin{verbatim}
Timestep Function 
  Real Procedure "LevelSet" "LevelSetTimestep"
\end{verbatim}
%
\sifbegin
\sifitem{LevelSet Courant Number}{Real}
This keyword gives the desired Courant number of for the level-set 
solvers. The default for the desired Courant number is one. 

\sifitem{LevelSet Timestep Directional}{Logical}
If the timestep limit is active this option may be used to account only the normal
direction of the interface velocity rather that the absolute direction. 
Default is \texttt{False}. 

\sifend
\sifend


%\bibliography{elmerbib}
%\bibliographystyle{plain}

