\chapter{Free Surface Kinematic Equation with Limiters}

\modinfo{Module name}{\Idx{FreeSurfaceSolver}}
\modinfo{Module subroutines}{FreeSurfaceSolver}
\modinfo{Module authors}{Thomas Zwinger, Peter Råback, Juha Ruokolainen, Mikko Lyly}
\modinfo{Document authors}{Thomas Zwinger}
\modinfo{Document edited}{March 4th 2008}


\section{Introduction}

Flows with a free surface are to be found in geophysical as well as technical applications. On large scale flows the free surface usually is governed by a kinematic boundary condition given as a partial differential equation. This equation then is solved on the specific boundary in combination with the (Navier)-Stokes equation and the mesh update solver.


\section{Theory}

The implicit equation describing the free surface is given by
\begin{equation}\label{fsl:implicit}
F(\vec{x},t) = z - h(x,y,t),
\end{equation}
with the explicit position of the free surface $h(x,y,t)$.
Mass conservation implies that, with respect to the velocity of the surface, $\vec{u}_{\text{m}}$, $F$ has to define a substantial surface\index{substantial surface}, i.e., 
\begin{equation}\label{fsl:implicitPDE}
  \dfrac{\partial F}{\partial t} + \vec{u}_{\text{m}}\nabla F = 0.
\end{equation}
The net volume flux through the free surface then is given by the projection of the difference between the fluid velocity at the free surface, $\vec{u}$ and the velocity of the free surface with respect to the surface normal
\begin{equation}\label{fsl:accum}
a_{\perp} = (\vec{u}_{\text{m}} - \vec{u})\cdot\vec{n}.
\end{equation}
In Geophysical context (e.g., Glaciology), $a_{\perp}$ often is referred to as the net accumulation\index{accumulation}.
With the surface unit normal defined as
\begin{equation}
\vec{n} = \dfrac{\nabla F}{\|\nabla F\|},
\end{equation}
this leads to
\begin{equation}\label{fsl:implicitPDEaccum}
  \dfrac{\partial F}{\partial t} + \vec{u}\nabla F = -\|\nabla F\| a_{\perp}.
\end{equation}
Using the definition in (\ref{fsl:implicit}), (\ref{fsl:implicitPDEaccum}) can be rewritten in its explicit form
\begin{equation}\label{fsl:explicitPDEaccum}
  \dfrac{\partial h}{\partial t} + u\dfrac{\partial h}{\partial x} + v\dfrac{\partial h}{\partial y} - w = \left[ 1 + \left(\dfrac{\partial h}{\partial x}\right)^{2} + \left(\dfrac{\partial h}{\partial y}\right)^{2} \right]^{1/2} \,  a_{\perp},
\end{equation}
with the components of fluid velocity vector at the free surface given as $\vec{u} = (u, \, v, \, w)^{\text{T}}$.
The variational formulation of (\ref{fsl:explicitPDEaccum}) reads as
\begin{equation}\label{fsl:variational}
%\begin{split}
 \int\limits_{\Omega}  \left(\dfrac{\partial h}{\partial t} + u\dfrac{\partial h}{\partial x} + v\dfrac{\partial h}{\partial y}\right)\,\varphi\,dV
 = \int\limits_{\Omega}\left\{ w + \left[ 1 + \left(\dfrac{\partial h}{\partial x}\right)^{2} + \left(\dfrac{\partial h}{\partial y}\right)^{2} \right]^{1/2}\,  a_{\perp}\right\}\varphi\,dV ,
%\end{split}
\end{equation}
where the occurrence of $h$ in the right hand side is inserted from the previous time-step/non-linear iteration, hence linearizing the equation.


\subsection{Limiters}
In certain cases the free surface is constrained by an upper $h_{\text{max}}(x,y,t)$ and/or a lower $h_{\text{min}}(x,y,t)$ limit. For instance, the free surface of a  fluid contained in a vessel cannot penetrate the vessel's walls. This adds the constraint
\begin{equation}\label{fsl:constraint}
h_{\text{min}} \le h \le h_{\text{max}}
\end{equation}
to (\ref{fsl:variational}) converting the variational formulation into a variational inequality\index{variational inequality}. In order to obtain a with (\ref{fsl:constraint}) consistent solution a method using Dirichlet constraints within the domain is applied. The exact procedure is the following:
\begin{enumerate}
\item construct the linear system: $\pmb{A}\vec{h} = \vec{f}$, with the system matrix $\pmb{A}$ and the solution vector $\vec{h}$ on the left-hand side and the force vector $\vec{f}$ on the right hand side
\item set nodes as \textit{active} if (\ref{fsl:constraint}) is violated
\item for \textit{active} nodes the matrix and force vector are manipulated such that effectively a Dirichlet condition $h = h_{\text{max/min}}$ is applied
\item the manipulated system is solved: $\tilde{\pmb{A}}\vec{\tilde{h}} = \vec{\tilde{f}}$
\item a residual is obtained from the un-manipulated system: $\vec{R}=\pmb{A}\vec{\tilde{h}} - \vec{f}$
\item an \textit{active} node is reset if the residual is $R<0$ (for lower limit) and $R>0$ (for upper limit)
\end{enumerate}
The whole algorithm is iterated (within the non-linear iteration loop) until the limit given in \texttt{Nonlinear System Convergence Tolerance} is reached. In the converged solution the residual represents the needed accumulation/volume flux (on matrix level, hence not in physical units) needed in order to obtain the limited solution. Consequently, the system not necessarily is volume conserving if the Dirichlet method is applied.
\section{Constraints}
The code only works in Cartesian coordinates and -- by the nature of the differential equation -- effectively converges only in a transient simulation. Although, technically, it also can be run in steady state simulations.
\section{Keywords}

\sifbegin
\sifitemnt{Solver}{solver id}
 \sifbegin
 \sifitemnt{Equation}{String "Free Surface Limited"}
 \sifitem{Variable}{String varname}
The change in the free surface coordinate. 
This may be of any name as far as it is used consistently also elsewhere, as \texttt{varname} is used as a preceding keyword for the exported variable of the residual, as well as for the accumulation
 \sifitem{Variable DOFs}{Integer 1}
Degrees of freedom for the free surface coordinate.
 \sifitem{Procedure}{File "FreeSurfaceSolver"\ "FreeSurfaceSolver"}
The following four keywords are used for output control.

 \sifitem{Velocity Implicitness}{Real}
Determines the level of implicitness in the velocity field. Values shall be in the interval $c_v \in [0,1]$. The velocity is interpolated between the current and the previous time level such that $u = (1-c_v)\,u^{n-1} + c_v\,u^{n}$. Thus, unity corresponds to complete implicitness (default).
 \sifitem{Maximum Displacement}{Real}
This limits the maximal local displacement in a time-step. If exceeded, relaxation automatically is applied in order to limit the displacement.
 \sifitem{Apply Dirichlet}{Logical}
Takes the variational inequality method (here referred to as Dirichlet method) into use. The user should be aware that if the method is applied (value \texttt{True}) this implies setting the \texttt{Nonlinear Max Iterations} to a value large enough for the method to converge.
 \sifitem{Relaxation Factor}{Real}
The changes in the free surface may be relaxed. The 
default is no relaxation or value 1.0
 \sifitem{Stabilization Method}{String}
Sets stabilization method. Either \texttt{Stabilized} or \texttt{Bubbles} can be set.
 \sifitem{Nonlinear System Convergence Tolerance}{Real} 
This keyword gives a criterion to
terminate the nonlinear iteration after the maximum change in the 
free surface coordinate is small enough
\begin{equation}
 \max || d R / ( R - R_0 ) ||  < \epsilon 
\end{equation}
where $\epsilon$ is the value given with this keyword.
 \sifitem{Exported Variable 1}{String}
The residual, which is the essential property in solving the variational inequality has to be given as an exported variable. The name is fixed by the variable name  \texttt{varname}  given in the Solver section plus \texttt{Residual}. For instance, if the variable is named \texttt{FreeSurf}, the exported variable is expected to be \texttt{FreeSurf Residual}.
 \sifitem{Exported Variable 1 DOFS}{Integer}
 As the free surface is a scalar, the value has to be set to 1.
 \sifend
\sifitemnt{Equation}{eq id}
 \sifbegin
 \sifitem{Convection}{String}
The type of convection to be used: \texttt{None} (default), \texttt{Computed}, \texttt{Constant}. In the last case, the keyword \texttt{Convection Velocity} is expected to be found in the Material section.
 \sifend
\sifitemnt{Body Force}{bf id}
 \sifbegin
 \sifitem{varname Accumulation}{Real}
   sets the value for the normal accumulation/volume flux, $a_{\perp}$ for the variable name \texttt{varname}. If this keyword is set, the following keyword \texttt{varname Accumulation Flux} is ignored (as those are excluding)
 \sifitem{varname Accumulation Flux i}{Real}
   sets the accumulation flux in Cartesian components (\texttt{i} = 1,2,3 in 3-dimensional problem). The resulting vertical flux then is evaluated using the surface normal.
 \sifend
\sifitemnt{Initial Condition}{ic id}
 \sifbegin
 \sifitem{varname}{Real}
   Initiation of the free surface variable (sets initial shape of surface)
 \sifend
\sifitemnt{Boundary Condition}{bc id}
 \sifbegin
 \sifitem{Body ID}{Integer}
 usually, the solver is run on a lower dimensional boundary of the model. Then a separate body-id has to be defined and all component of the solver (\texttt{Equation}, \texttt{Body Force}, \texttt{Equation},  \texttt{Initial Condition} and   \texttt{Material}) defined accordingly.
 \sifitem{varname}{Real}
   Dirichlet condition of the free surface variable (makes really sense only on dimension - 2 boundaries, e.g. lines in case of a three dimensional run) 
 \sifitem{Mesh Update i}{Real}
  usually, the free surface evolution should have a feedback on the domain's geometry. This usually is achieved by running the MeshUpdate Solver and linking the variable of the free surface with the corresponding component of the \texttt{Mesh Update} (i=1,2,3). For instance, in a 3-dimensional case with the variable name \texttt{FreeSurf} this could read as: \texttt{Mesh Update 3 = Equals FreeSurf}
 \sifend 
\sifend


%\bibliography{elmerbib}
%\bibliographystyle{plain}

